#!/usr/bin/env bash
set -euo pipefail

# List GitHub Copilot session logs: filename, project root, first user message.

base="${HOME}/.copilot/session-state"
[[ -d "$base" ]] || exit 0

filter="${1:-}"

# Sort by modification time: newest sessions first.
find "$base" -type f -name '*.jsonl' -printf '%T@:%p\0' \
  | sort -zrn \
  | while IFS= read -r -d '' entry; do
      logfile="${entry#*:}"
      FILE="$logfile" FILTER="$filter" jq -nr --slurpfile rows "$logfile" '
        def first_value(f):
          ([ $rows[] | f ] | map(select(. != null and . != "")) | .[0] // "");

        def indent_block(s):
          "    " + ((s // "") | gsub("\n"; "\n    ")) + "\n";

        def trim_path:
          (. // "") as $raw
          | if $raw == "" then ""
            else
              ($raw | sub("/+$"; "")) as $trim
              | if ($raw | endswith("/")) then
                  $trim
                else
                  ($trim | match("^(?<dir>.*)/[^/]+$")?.captures[0].string // $trim)
                end
            end;

        def first_directory:
          first_value(
            if (.type // "") == "assistant.message" then
              (.data.toolRequests[]? | .arguments.path // "")
            elif (.type // "") == "tool.execution_start" then
              (.data.arguments.path // "")
            else ""
            end
          ) | trim_path;

        def first_user_message:
          first_value(
            if (.type // "") == "user.message" then
              (.data.content // "")
            else ""
            end
          );

        def block(file; path; message):
          "# " + file + "\n"
          + indent_block(path)
          + indent_block(message);

        def truncate_middle:
          (. // "") as $s
          | ($s | explode) as $chars
          | if ($chars | length) <= 500 then
              $s
            else
              ($chars[:250] | implode)
              + "...truncated..."
              + ($chars[-250:] | implode)
            end;

        def matches_filter(path):
          (env.FILTER // "") as $f
          | if $f == "" then
              true
            else
              (path // "") | contains($f)
            end;

        first_directory as $path
        | (first_user_message | truncate_middle) as $msg
        | if matches_filter($path) then
            block(env.FILE; $path; $msg)
          else
            empty
          end
      '
    done
